name: üìû VoxCall

on:
  workflow_dispatch:

concurrency:
  group: voxcall
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }

      - name: Install & verify
        run: |
          npm install
          node --check server.js && echo "‚úÖ syntax ok"
          node -e "require('express');require('socket.io');console.log('‚úÖ deps ok')"

      - name: Start server
        run: |
          nohup node server.js > /tmp/app.log 2>&1 &
          echo $! > /tmp/app.pid
          sleep 3

          if ! kill -0 $(cat /tmp/app.pid) 2>/dev/null; then
            echo "‚ùå CRASHED"; cat /tmp/app.log; exit 1
          fi

          for i in $(seq 1 15); do
            curl -sf http://localhost:8080 > /dev/null && echo "‚úÖ up" && break
            echo "  wait $i..."; sleep 2
          done

          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080)
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå HTTP $STATUS"; cat /tmp/app.log; exit 1
          fi

      - name: Tunnel
        run: |
          curl -sL -o cf https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cf

          nohup ./cf tunnel --url http://127.0.0.1:8080 --no-autoupdate --protocol http2 > /tmp/cf.log 2>&1 &
          echo $! > /tmp/cf.pid

          URL=""
          for i in $(seq 1 30); do
            URL=$(grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/cf.log | head -1)
            [ -n "$URL" ] && break; sleep 2
          done

          if [ -z "$URL" ]; then echo "‚ùå tunnel failed"; cat /tmp/cf.log; exit 1; fi

          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üìû VoxCall LIVE"
          echo "  $URL"
          echo ""
          echo "  Share this link. Enter same code."
          echo "  Talk."
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "$URL" > /tmp/url.txt

      - name: Keep alive
        run: |
          URL=$(cat /tmp/url.txt)
          echo "üìû Live: $URL"
          END=$(($(date +%s) + 21300))
          while [ $(date +%s) -lt $END ]; do
            if ! kill -0 $(cat /tmp/app.pid) 2>/dev/null; then
              echo "‚ö†Ô∏è restart server"
              nohup node server.js > /tmp/app.log 2>&1 &
              echo $! > /tmp/app.pid
            fi
            if ! kill -0 $(cat /tmp/cf.pid) 2>/dev/null; then
              echo "‚ö†Ô∏è restart tunnel"
              nohup ./cf tunnel --url http://127.0.0.1:8080 --no-autoupdate --protocol http2 > /tmp/cf.log 2>&1 &
              echo $! > /tmp/cf.pid
              sleep 10
              NURL=$(grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/cf.log | head -1)
              [ -n "$NURL" ] && echo "üîÑ New URL: $NURL"
            fi
            sleep 60
          done
          echo "‚è∞ Done"
