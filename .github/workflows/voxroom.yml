name: üìû VoxCall

on:
  workflow_dispatch:

concurrency:
  group: voxcall
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }

      - name: Install & verify
        run: |
          npm install
          node --check server.js && echo "‚úÖ syntax ok"
          node -e "require('express');require('socket.io');console.log('‚úÖ deps ok')"

      - name: Start server
        run: |
          nohup node server.js > /tmp/app.log 2>&1 &
          echo $! > /tmp/app.pid
          sleep 3

          if ! kill -0 $(cat /tmp/app.pid) 2>/dev/null; then
            echo "‚ùå CRASHED"
            cat /tmp/app.log
            exit 1
          fi

          for i in $(seq 1 15); do
            curl -sf http://localhost:8080 > /dev/null && echo "‚úÖ server up" && break
            echo "  wait $i..."
            sleep 2
          done

          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080)
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå HTTP $STATUS"
            cat /tmp/app.log
            exit 1
          fi

      - name: Tunnel
        run: |
          curl -sL -o cf https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cf

          nohup ./cf tunnel --url http://localhost:8080 --no-autoupdate > /tmp/cf.log 2>&1 &
          echo $! > /tmp/cf.pid

          URL=""
          for i in $(seq 1 40); do
            URL=$(grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/cf.log | head -1)
            [ -n "$URL" ] && break
            sleep 2
          done

          if [ -z "$URL" ]; then
            echo "‚ùå tunnel failed"
            cat /tmp/cf.log
            exit 1
          fi

          sleep 5

          VERIFIED=0
          for i in $(seq 1 10); do
            HTTP=$(curl -o /dev/null -sf -w "%{http_code}" --max-time 10 "$URL" 2>/dev/null || echo "000")
            echo "  verify $i: HTTP $HTTP"
            if [ "$HTTP" = "200" ]; then
              VERIFIED=1
              break
            fi
            sleep 3
          done

          if [ "$VERIFIED" = "0" ]; then
            echo "‚ö†Ô∏è Retrying tunnel..."
            kill $(cat /tmp/cf.pid) 2>/dev/null
            sleep 2
            nohup ./cf tunnel --url http://localhost:8080 --no-autoupdate > /tmp/cf.log 2>&1 &
            echo $! > /tmp/cf.pid
            sleep 10
            URL=$(grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/cf.log | head -1)
          fi

          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üìû VoxCall LIVE"
          echo "  $URL"
          echo "  Share link. Same code. Talk."
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "$URL" > /tmp/url.txt

      - name: Keep alive
        run: |
          URL=$(cat /tmp/url.txt)
          echo "üìû Live: $URL"
          END=$(($(date +%s) + 21300))
          COUNT=0
          while [ $(date +%s) -lt $END ]; do
            if ! kill -0 $(cat /tmp/app.pid) 2>/dev/null; then
              echo "‚ö†Ô∏è restart server"
              nohup node server.js > /tmp/app.log 2>&1 &
              echo $! > /tmp/app.pid
              sleep 3
            fi
            if ! kill -0 $(cat /tmp/cf.pid) 2>/dev/null; then
              echo "‚ö†Ô∏è restart tunnel"
              nohup ./cf tunnel --url http://localhost:8080 --no-autoupdate > /tmp/cf.log 2>&1 &
              echo $! > /tmp/cf.pid
              sleep 10
              NURL=$(grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/cf.log | head -1)
              [ -n "$NURL" ] && echo "üîÑ $NURL"
            fi
            COUNT=$((COUNT+1))
            if [ $((COUNT % 5)) -eq 0 ]; then
              REM=$(( (END - $(date +%s)) / 60 ))
              echo "üíì [${REM}m left]"
            fi
            sleep 60
          done
          echo "‚è∞ Done"
