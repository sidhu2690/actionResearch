name: üì± VoxRoom Live

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

concurrency:
  group: voxroom
  cancel-in-progress: false

jobs:
  serve:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm install
          echo ""
          echo "=== Installed packages ==="
          ls node_modules/ | head -20
          echo ""
          echo "=== Checking key deps ==="
          node -e "require('express'); console.log('‚úÖ express')"
          node -e "require('socket.io'); console.log('‚úÖ socket.io')"
          node -e "require('uuid'); console.log('‚úÖ uuid')"
          node -e "require('cors'); console.log('‚úÖ cors')"
          echo ""
          echo "=== Syntax check ==="
          node --check server.js && echo "‚úÖ server.js syntax OK" || echo "‚ùå server.js syntax ERROR"

      - name: Start server
        run: |
          # Show what we're running
          echo "=== server.js first 5 lines ==="
          head -5 server.js
          echo ""
          echo "=== public/ contents ==="
          find public/ -type f 2>/dev/null || echo "No public/ dir found"
          echo ""

          # Start server
          nohup node server.js > /tmp/server.log 2>&1 &
          echo $! > /tmp/server.pid
          echo "Server PID: $(cat /tmp/server.pid)"

          # Give it a moment to start (or crash)
          sleep 3

          # Check if process is still alive
          if ! kill -0 $(cat /tmp/server.pid) 2>/dev/null; then
            echo ""
            echo "‚ùå SERVER CRASHED ON STARTUP!"
            echo "=== Server Log ==="
            cat /tmp/server.log
            echo "=================="
            exit 1
          fi

          # Wait for HTTP response
          echo "Waiting for HTTP response..."
          for i in $(seq 1 20); do
            if curl -sf http://localhost:8080 > /dev/null 2>&1; then
              echo "‚úÖ Server responding on attempt $i"
              break
            fi
            if ! kill -0 $(cat /tmp/server.pid) 2>/dev/null; then
              echo "‚ùå Server died during startup!"
              cat /tmp/server.log
              exit 1
            fi
            echo "  waiting... attempt $i"
            sleep 2
          done

          # Final check
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080)
          echo "HTTP status: $STATUS"

          if [ "$STATUS" != "200" ]; then
            echo ""
            echo "‚ùå Server not responding with 200!"
            echo "=== Server Log ==="
            cat /tmp/server.log
            echo "=================="
            exit 1
          fi

          echo ""
          echo "=== Health check ==="
          curl -s http://localhost:8080/api/health
          echo ""
          echo "‚úÖ Server is healthy!"

      - name: Start tunnel
        run: |
          curl -sL -o cloudflared \
            https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared

          nohup ./cloudflared tunnel \
            --url http://127.0.0.1:8080 \
            --no-autoupdate \
            --protocol http2 \
            > /tmp/tunnel.log 2>&1 &
          echo $! > /tmp/tunnel.pid
          echo "Tunnel PID: $(cat /tmp/tunnel.pid)"

          URL=""
          for i in $(seq 1 45); do
            URL=$(grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/tunnel.log | head -1)
            if [ -n "$URL" ]; then
              echo "Tunnel URL found on attempt $i"
              break
            fi
            sleep 2
          done

          if [ -z "$URL" ]; then
            echo "‚ùå Tunnel failed!"
            cat /tmp/tunnel.log
            exit 1
          fi

          sleep 5

          TRIES=0
          while [ $TRIES -lt 5 ]; do
            TSTATUS=$(curl -o /dev/null -sf -w "%{http_code}" --max-time 15 "$URL" 2>/dev/null)
            if [ "$TSTATUS" = "200" ]; then
              echo "‚úÖ Tunnel verified (HTTP $TSTATUS)"
              break
            fi
            echo "  tunnel check $TRIES (HTTP $TSTATUS)..."
            TRIES=$((TRIES+1))
            sleep 3
          done

          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  üì± VOXROOM LIVE                            ‚ïë"
          echo "‚ïë                                             ‚ïë"
          echo "‚ïë  $URL"
          echo "‚ïë                                             ‚ïë"
          echo "‚ïë  Share this URL to start calling!            ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""

          echo "$URL" > /tmp/tunnel_url.txt

      - name: Keep alive
        run: |
          URL=$(cat /tmp/tunnel_url.txt 2>/dev/null || echo "unknown")
          echo "üì± VoxRoom live at: $URL"
          echo "Running for ~5h 55m..."

          END=$(($(date +%s) + 21300))
          HEARTBEAT=0

          while [ $(date +%s) -lt $END ]; do
            # Check server
            if ! kill -0 $(cat /tmp/server.pid) 2>/dev/null; then
              echo "‚ö†Ô∏è Server died! Logs:"
              tail -30 /tmp/server.log
              echo "Restarting..."
              nohup node server.js > /tmp/server.log 2>&1 &
              echo $! > /tmp/server.pid
              sleep 5
            fi

            # Check tunnel
            if ! kill -0 $(cat /tmp/tunnel.pid) 2>/dev/null; then
              echo "‚ö†Ô∏è Tunnel died! Restarting..."
              nohup ./cloudflared tunnel \
                --url http://127.0.0.1:8080 \
                --no-autoupdate \
                --protocol http2 \
                > /tmp/tunnel.log 2>&1 &
              echo $! > /tmp/tunnel.pid
              sleep 10
              NEWURL=$(grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/tunnel.log | head -1)
              if [ -n "$NEWURL" ]; then
                echo "üîÑ New tunnel: $NEWURL"
              fi
            fi

            HEARTBEAT=$((HEARTBEAT+1))
            if [ $((HEARTBEAT % 5)) -eq 0 ]; then
              HEALTH=$(curl -sf http://localhost:8080/api/health 2>/dev/null || echo "unreachable")
              REMAINING=$(( (END - $(date +%s)) / 60 ))
              echo "üíì [${REMAINING}m left] $HEALTH"
            fi

            sleep 60
          done

          echo "‚è∞ Done."
          tail -20 /tmp/server.log
