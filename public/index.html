<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>VoxCall</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  background:#0a0a0a;color:#fff;
  height:100vh;display:flex;
  align-items:center;justify-content:center;
}

/* JOIN SCREEN */
#joinScreen{
  text-align:center;
  padding:24px;
  width:100%;max-width:360px;
}
#joinScreen h1{
  font-size:48px;margin-bottom:4px;
}
#joinScreen p{
  color:#888;font-size:14px;margin-bottom:32px;
}
#codeInput{
  width:100%;padding:16px;
  font-size:28px;font-weight:700;
  text-align:center;letter-spacing:8px;
  text-transform:uppercase;
  background:#1a1a1a;border:2px solid #333;
  border-radius:12px;color:#fff;
  outline:none;
}
#codeInput:focus{border-color:#22c55e}
#codeInput::placeholder{
  color:#444;letter-spacing:4px;font-weight:400;font-size:16px;
}
#joinBtn{
  width:100%;padding:16px;margin-top:16px;
  font-size:18px;font-weight:600;
  background:#22c55e;color:#fff;
  border:none;border-radius:12px;cursor:pointer;
}
#joinBtn:hover{background:#16a34a}
#joinBtn:active{transform:scale(.98)}
#joinBtn:disabled{background:#333;color:#666;cursor:default}
#error{
  color:#ef4444;font-size:13px;
  margin-top:12px;min-height:20px;
}

/* CALL SCREEN */
#callScreen{
  display:none;
  text-align:center;
  padding:24px;
  width:100%;height:100vh;
  flex-direction:column;
  align-items:center;
  justify-content:space-between;
  padding:60px 24px 80px;
}
#callScreen.active{display:flex}
#joinScreen.hidden{display:none}

.room-label{
  font-size:14px;color:#888;
  margin-bottom:4px;
}
.room-code{
  font-size:20px;font-weight:700;
  letter-spacing:4px;color:#22c55e;
  font-family:'Courier New',monospace;
}

.call-circle{
  width:140px;height:140px;
  border-radius:50%;
  background:#1a1a1a;
  border:3px solid #333;
  display:flex;align-items:center;
  justify-content:center;
  font-size:56px;
  margin:0 auto;
  transition:all .3s;
}
.call-circle.connected{
  border-color:#22c55e;
  box-shadow:0 0 40px #22c55e22;
}
.call-circle.waiting{
  animation:waitPulse 2s infinite;
}
@keyframes waitPulse{
  0%,100%{border-color:#333;box-shadow:none}
  50%{border-color:#22c55e55;box-shadow:0 0 30px #22c55e11}
}

#callStatus{
  font-size:18px;font-weight:500;
  margin-top:16px;
}
#callTimer{
  font-size:14px;color:#888;
  margin-top:4px;
  font-family:'Courier New',monospace;
}
#quality{
  font-size:12px;margin-top:8px;
  padding:4px 12px;border-radius:8px;
  display:inline-block;
}
.qgood{background:#22c55e22;color:#22c55e}
.qmed{background:#f59e0b22;color:#f59e0b}
.qbad{background:#ef444422;color:#ef4444}

.controls{display:flex;gap:24px;align-items:center}
.ctrl-btn{
  width:64px;height:64px;border-radius:50%;
  border:none;cursor:pointer;
  font-size:28px;color:#fff;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.ctrl-btn:active{transform:scale(.9)}
#muteBtn{background:#333}
#muteBtn.muted{background:#ef4444}
#hangBtn{background:#ef4444;width:72px;height:72px;font-size:32px}
#hangBtn:hover{background:#dc2626}
</style>
</head>
<body>

<!-- JOIN -->
<div id="joinScreen">
  <h1>üìû</h1>
  <p>Enter a room code. Same code = instant call.</p>
  <input type="text" id="codeInput" placeholder="ROOM CODE" maxlength="8" autocomplete="off">
  <button id="joinBtn">Join Room</button>
  <div id="error"></div>
</div>

<!-- CALL -->
<div id="callScreen">
  <div>
    <div class="room-label">ROOM</div>
    <div class="room-code" id="showCode">------</div>
  </div>

  <div>
    <div class="call-circle waiting" id="callCircle">üìû</div>
    <div id="callStatus">Waiting for other person...</div>
    <div id="callTimer"></div>
    <div id="quality" class="qgood">‚óè Good</div>
  </div>

  <div class="controls">
    <button class="ctrl-btn" id="muteBtn">üé§</button>
    <button class="ctrl-btn" id="hangBtn">üìµ</button>
  </div>
</div>

<audio id="remoteAudio" autoplay playsinline></audio>

<script src="/socket.io/socket.io.js"></script>
<script>
(function(){

const ICE = {
  iceServers: [
    {urls:"stun:stun.l.google.com:19302"},
    {urls:"stun:stun1.l.google.com:19302"},
    {urls:"stun:stun2.l.google.com:19302"},
    {urls:"stun:stun3.l.google.com:19302"},
  ]
};

let socket = null;
let pc = null;
let localStream = null;
let muted = false;
let callStart = null;
let timerInterval = null;
let qualityInterval = null;
let currentRoom = null;

const $ = id => document.getElementById(id);

// ‚îÄ‚îÄ JOIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$("joinBtn").onclick = join;
$("codeInput").onkeydown = e => { if(e.key==="Enter") join() };
$("codeInput").oninput = () => {
  $("codeInput").value = $("codeInput").value.toUpperCase().replace(/[^A-Z0-9]/g,"");
};

function join(){
  const code = $("codeInput").value.trim();
  if(!code || code.length < 3){
    $("error").textContent = "Enter at least 3 characters";
    return;
  }

  $("joinBtn").disabled = true;
  $("joinBtn").textContent = "Joining...";
  $("error").textContent = "";

  // Get mic FIRST
  navigator.mediaDevices.getUserMedia({
    audio: {
      echoCancellation: true,
      noiseSuppression: true,
      autoGainControl: true,
      sampleRate: 16000,
      channelCount: 1,
    },
    video: false,
  }).then(stream => {
    localStream = stream;
    connectAndJoin(code);
  }).catch(e => {
    $("joinBtn").disabled = false;
    $("joinBtn").textContent = "Join Room";
    $("error").textContent = "Microphone access denied. Allow mic and try again.";
    console.error("Mic error:", e);
  });
}

function connectAndJoin(code){
  socket = io({ transports:["websocket","polling"], reconnection:true });

  socket.on("connect", () => {
    socket.emit("join", code, res => {
      if(!res.ok){
        $("joinBtn").disabled = false;
        $("joinBtn").textContent = "Join Room";
        $("error").textContent = res.error;
        if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
        socket.disconnect();
        return;
      }
      currentRoom = code;
      showCallScreen(code);

      if(res.count === 2){
        // Other person already here, start call
        startCall(true);
      }
    });
  });

  socket.on("start-call", () => {
    startCall(true);
  });

  socket.on("signal", async data => {
    if(!pc) createPC(false);
    try{
      if(data.type === "offer"){
        await pc.setRemoteDescription(new RTCSessionDescription(data));
        const answer = await pc.createAnswer();
        answer.sdp = tweakSDP(answer.sdp);
        await pc.setLocalDescription(answer);
        socket.emit("signal", pc.localDescription);
      } else if(data.type === "answer"){
        await pc.setRemoteDescription(new RTCSessionDescription(data));
      } else if(data.candidate){
        await pc.addIceCandidate(new RTCIceCandidate(data));
      }
    }catch(e){ console.error("Signal error:", e); }
  });

  socket.on("peer-left", () => {
    $("callStatus").textContent = "Other person left. Waiting...";
    $("callCircle").className = "call-circle waiting";
    $("callCircle").textContent = "üìû";
    $("callTimer").textContent = "";
    stopTimer();
    cleanupPC();
  });

  socket.on("room-count", n => {
    if(n < 2){
      $("callStatus").textContent = "Waiting for other person...";
      $("callCircle").className = "call-circle waiting";
    }
  });

  socket.on("disconnect", () => {
    $("callStatus").textContent = "Reconnecting...";
  });

  socket.on("reconnect", () => {
    if(currentRoom){
      socket.emit("join", currentRoom, res => {
        if(res.ok && res.count === 2) startCall(true);
      });
    }
  });
}

function showCallScreen(code){
  $("joinScreen").classList.add("hidden");
  $("callScreen").classList.add("active");
  $("showCode").textContent = code;
}

// ‚îÄ‚îÄ WebRTC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function createPC(making_offer){
  if(pc){ try{pc.close()}catch(e){} }

  pc = new RTCPeerConnection(ICE);

  // Add mic tracks
  if(localStream){
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  }

  pc.onicecandidate = e => {
    if(e.candidate) socket.emit("signal", e.candidate);
  };

  pc.ontrack = e => {
    console.log("üîä Got remote audio");
    $("remoteAudio").srcObject = e.streams[0];
    $("remoteAudio").play().catch(()=>{
      document.addEventListener("click", function r(){
        $("remoteAudio").play().catch(()=>{});
        document.removeEventListener("click",r);
      },{once:true});
    });
  };

  pc.onconnectionstatechange = () => {
    console.log("State:", pc.connectionState);
    switch(pc.connectionState){
      case "connected":
        $("callStatus").textContent = "Connected";
        $("callCircle").className = "call-circle connected";
        $("callCircle").textContent = "üîä";
        startTimer();
        startQualityCheck();
        break;
      case "disconnected":
        $("callStatus").textContent = "Connection lost...";
        $("callCircle").className = "call-circle waiting";
        break;
      case "failed":
        $("callStatus").textContent = "Connection failed. Retrying...";
        try{ pc.restartIce(); }catch(e){
          // Full reconnect
          cleanupPC();
          setTimeout(()=>{ if(currentRoom) startCall(true); }, 2000);
        }
        break;
    }
  };

  pc.oniceconnectionstatechange = () => {
    if(pc.iceConnectionState === "failed"){
      try{ pc.restartIce(); }catch(e){}
    }
  };

  return pc;
}

async function startCall(shouldOffer){
  createPC(shouldOffer);

  if(shouldOffer){
    try{
      const offer = await pc.createOffer({
        offerToReceiveAudio: true,
        offerToReceiveVideo: false,
        voiceActivityDetection: true,
      });
      offer.sdp = tweakSDP(offer.sdp);
      await pc.setLocalDescription(offer);
      socket.emit("signal", pc.localDescription);
      console.log("üì§ Sent offer");
    }catch(e){
      console.error("Offer failed:", e);
    }
  }

  $("callStatus").textContent = "Connecting...";
}

function tweakSDP(sdp){
  // Optimize for low bandwidth voice
  let s = sdp;
  s = s.replace(
    /a=fmtp:111 /g,
    "a=fmtp:111 maxaveragebitrate=24000;stereo=0;usedtx=1;"
  );
  return s;
}

function cleanupPC(){
  if(qualityInterval){ clearInterval(qualityInterval); qualityInterval=null; }
  if(pc){ try{pc.close()}catch(e){} pc=null; }
}

// ‚îÄ‚îÄ QUALITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startQualityCheck(){
  if(qualityInterval) clearInterval(qualityInterval);
  qualityInterval = setInterval(async()=>{
    if(!pc || pc.connectionState!=="connected") return;
    try{
      const stats = await pc.getStats();
      let rtt=0, lost=0, recv=0;
      stats.forEach(r=>{
        if(r.type==="candidate-pair" && r.state==="succeeded")
          rtt = r.currentRoundTripTime || 0;
        if(r.type==="inbound-rtp" && r.kind==="audio"){
          lost = r.packetsLost||0;
          recv = r.packetsReceived||0;
        }
      });
      const loss = recv>0 ? lost/(lost+recv) : 0;
      const ms = Math.round(rtt*1000);

      let q,cls;
      if(rtt>0.4 || loss>0.1){ q=`‚óè Poor ${ms}ms`; cls="qbad"; setBitrate(12000); }
      else if(rtt>0.2 || loss>0.03){ q=`‚óè Fair ${ms}ms`; cls="qmed"; setBitrate(24000); }
      else { q=`‚óè Good ${ms}ms`; cls="qgood"; setBitrate(48000); }

      $("quality").textContent = q;
      $("quality").className = cls;
    }catch(e){}
  }, 3000);
}

function setBitrate(bps){
  if(!pc) return;
  pc.getSenders().forEach(s=>{
    if(s.track && s.track.kind==="audio"){
      const p = s.getParameters();
      if(!p.encodings||!p.encodings.length) p.encodings=[{}];
      p.encodings[0].maxBitrate = bps;
      s.setParameters(p).catch(()=>{});
    }
  });
}

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startTimer(){
  callStart = Date.now();
  stopTimer();
  timerInterval = setInterval(()=>{
    const s = Math.floor((Date.now()-callStart)/1000);
    const m = Math.floor(s/60).toString().padStart(2,"0");
    const sec = (s%60).toString().padStart(2,"0");
    $("callTimer").textContent = `${m}:${sec}`;
  },1000);
}
function stopTimer(){
  if(timerInterval){clearInterval(timerInterval);timerInterval=null}
}

// ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$("muteBtn").onclick = () => {
  if(!localStream) return;
  muted = !muted;
  localStream.getAudioTracks().forEach(t=>{ t.enabled=!muted });
  $("muteBtn").textContent = muted ? "üîá" : "üé§";
  $("muteBtn").classList.toggle("muted", muted);
};

$("hangBtn").onclick = () => {
  cleanupPC();
  stopTimer();
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
  if(socket){ socket.disconnect(); socket=null; }
  currentRoom = null;

  // Back to join screen
  $("callScreen").classList.remove("active");
  $("joinScreen").classList.remove("hidden");
  $("joinBtn").disabled = false;
  $("joinBtn").textContent = "Join Room";
  $("callTimer").textContent = "";
  $("codeInput").value = "";
};

// ‚îÄ‚îÄ KEEP SCREEN ON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let wakeLock = null;
async function keepAwake(){
  if(!("wakeLock" in navigator)) return;
  try{ wakeLock=await navigator.wakeLock.request("screen") }catch(e){}
}
keepAwake();
document.addEventListener("visibilitychange",()=>{
  if(!document.hidden) keepAwake();
});

$("codeInput").focus();
console.log("üìû VoxCall ready");

})();
</script>
</body>
</html>
