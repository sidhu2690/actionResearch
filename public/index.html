<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VoxRoom</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#111b21;--panel:#1f2c34;--header:#202c33;
  --green:#00a884;--green2:#025144;--light:#e9edef;
  --gray:#8696a0;--bout:#005c4b;--bin:#202c33;
  --hover:#2a3942;--border:#313d45;--input:#2a3942;
  --danger:#ef5350;--chatbg:#0b141a;
}
html,body{height:100%;width:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--light);overflow:hidden}
button{cursor:pointer;border:none;outline:none;font-family:inherit;font-size:inherit;transition:all .15s}
button:active{transform:scale(.95)}
input{font-family:inherit;font-size:inherit;outline:none;border:none}

.screen{display:none;width:100%;height:100%;flex-direction:column}
.screen.active{display:flex}

/* â”â” WELCOME â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#welcomeScreen{align-items:center;justify-content:center;background:linear-gradient(135deg,#0b141a 0%,#1a2e35 50%,#0b141a 100%);gap:16px;padding:24px}
.wlogo{font-size:72px;margin-bottom:8px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.wtitle{font-size:32px;font-weight:300;letter-spacing:1px}
.wsub{font-size:14px;color:var(--gray);text-align:center;max-width:350px;line-height:1.5;margin-bottom:24px}
.wcard{background:var(--panel);border-radius:12px;padding:28px 24px;width:100%;max-width:400px;box-shadow:0 8px 32px #0004}
.fg{margin-bottom:18px}
.fg label{display:block;font-size:12px;color:var(--green);font-weight:600;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
.fg input{width:100%;padding:12px 14px;background:var(--input);border-radius:8px;color:var(--light);font-size:15px;border:1px solid transparent;transition:border .2s}
.fg input:focus{border-color:var(--green)}
.fg input::placeholder{color:var(--gray)}
.btnrow{display:flex;gap:10px;margin-top:20px}
.btn{flex:1;padding:13px 20px;border-radius:8px;font-size:15px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px}
.btn1{background:var(--green);color:#fff}
.btn1:hover{background:#00be96}
.btn2{background:var(--input);color:var(--light)}
.btn2:hover{background:var(--hover)}
.divider{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--gray);font-size:13px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}
.errmsg{color:var(--danger);font-size:13px;margin-top:8px;display:none}
.errmsg.show{display:block}

/* â”â” CHAT â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#chatScreen{background:var(--bg)}
.chdr{display:flex;align-items:center;padding:10px 16px;background:var(--header);border-bottom:1px solid var(--border);min-height:60px;gap:12px;z-index:10}
.chdr-av{width:40px;height:40px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff;flex-shrink:0}
.chdr-info{flex:1;min-width:0}
.chdr-name{font-size:16px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chdr-status{font-size:12px;color:var(--gray);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hacts{display:flex;gap:4px}
.ibtn{width:40px;height:40px;border-radius:50%;background:transparent;color:var(--gray);display:flex;align-items:center;justify-content:center;font-size:20px}
.ibtn:hover{background:var(--hover)}
.ibtn.active{color:var(--green)}

.msgs{flex:1;overflow-y:auto;padding:12px 16px;background:var(--chatbg);display:flex;flex-direction:column;gap:2px}
.msg{max-width:75%;padding:6px 10px;border-radius:8px;position:relative;line-height:1.4;word-wrap:break-word;font-size:14.2px;animation:fadeIn .2s}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.msg-out{align-self:flex-end;background:var(--bout);border-top-right-radius:2px;margin-left:48px}
.msg-in{align-self:flex-start;background:var(--bin);border-top-left-radius:2px;margin-right:48px}
.msg-sender{font-size:12.5px;font-weight:600;margin-bottom:2px}
.msg-text{color:var(--light)}
.msg-time{font-size:10.5px;color:var(--gray);text-align:right;margin-top:2px}
.msg-sys{align-self:center;background:#0b141acc;color:var(--gray);font-size:12px;padding:4px 12px;border-radius:6px;max-width:85%;text-align:center;margin:4px 0}

.typing{align-self:flex-start;background:var(--bin);border-radius:8px;padding:10px 14px;display:none;gap:4px;align-items:center}
.typing.show{display:flex}
.tdot{width:7px;height:7px;border-radius:50%;background:var(--gray);animation:tb 1.2s infinite}
.tdot:nth-child(2){animation-delay:.2s}
.tdot:nth-child(3){animation-delay:.4s}
@keyframes tb{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}

.inbar{display:flex;align-items:flex-end;padding:8px 12px;gap:8px;background:var(--header);border-top:1px solid var(--border)}
.inbar input{flex:1;padding:10px 14px;background:var(--input);border-radius:20px;color:var(--light);font-size:15px;min-width:0}
.inbar input::placeholder{color:var(--gray)}
.sendbtn{width:42px;height:42px;border-radius:50%;background:var(--green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.sendbtn:hover{background:#00be96}

/* â”â” CALL â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#callOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(180deg,#0b141a,#1a2e35 40%,#0b141a);z-index:100;display:none;flex-direction:column;align-items:center;justify-content:space-between;padding:40px 24px 48px}
#callOverlay.active{display:flex}
.cstatus{text-align:center;animation:fadeIn .3s}
.cav{width:96px;height:96px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:700;color:#fff;margin:0 auto 16px;box-shadow:0 0 0 4px var(--green2)}
.cav.ring{animation:rp 1.5s infinite}
@keyframes rp{0%{box-shadow:0 0 0 4px var(--green2)}50%{box-shadow:0 0 0 16px #00a88400}100%{box-shadow:0 0 0 4px var(--green2)}}
.cname{font-size:24px;font-weight:500;margin-bottom:4px}
.ctimer{font-size:14px;color:var(--gray)}
.cqual{font-size:12px;margin-top:8px;padding:4px 12px;border-radius:12px;display:inline-block}
.qg{background:#00a88433;color:#00a884}
.qm{background:#ff980033;color:#ff9800}
.qp{background:#ef535033;color:#ef5350}

.cpeers{display:flex;flex-wrap:wrap;gap:16px;justify-content:center}
.cpeer{text-align:center;animation:fadeIn .3s}
.cpeer-av{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700;color:#fff;margin:0 auto 6px}
.cpeer-name{font-size:13px;color:var(--gray)}

.cctrls{display:flex;gap:20px;align-items:center}
.cbtn{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff}
.cbtn-mute{background:var(--hover)}
.cbtn-mute.muted{background:var(--danger)}
.cbtn-end{background:var(--danger);width:64px;height:64px;font-size:28px}
.cbtn-spk{background:var(--hover)}
.cbtn-spk.active{background:var(--green)}

/* â”â” SETTINGS â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#settingsPanel{position:fixed;top:0;right:-320px;width:300px;height:100%;background:var(--panel);z-index:50;transition:right .3s;box-shadow:-4px 0 16px #0004;display:flex;flex-direction:column}
#settingsPanel.open{right:0}
.shdr{padding:16px;background:var(--header);display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
.shdr h3{flex:1;font-size:16px;font-weight:500}
.sbody{flex:1;overflow-y:auto;padding:16px}
.ssec{margin-bottom:24px}
.ssec h4{font-size:12px;color:var(--green);text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px}
.srow{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
.srow label{font-size:14px}
.srow select{background:var(--input);color:var(--light);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:14px}
.rcode{text-align:center;padding:16px;background:var(--bg);border-radius:8px;margin-bottom:16px}
.rcode .code{font-size:32px;font-weight:700;letter-spacing:6px;color:var(--green);font-family:'Courier New',monospace}
.rcode .clbl{font-size:12px;color:var(--gray);margin-bottom:8px}
.cpybtn{padding:8px 20px;border-radius:8px;background:var(--green);color:#fff;font-size:13px;font-weight:600;margin-top:10px}
.plist{display:flex;flex-direction:column;gap:8px}
.part{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:var(--bg)}
.part-av{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff;flex-shrink:0}
.part-info{flex:1;min-width:0}
.part-name{font-size:14px;font-weight:500}
.part-stat{font-size:11px;color:var(--gray)}
.odot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0}
.odot.off{background:var(--gray)}

.backdrop{position:fixed;top:0;left:0;right:0;bottom:0;background:#0008;z-index:49;display:none}
.backdrop.show{display:block}
@media(max-width:480px){.wcard{padding:20px 16px}.msg{max-width:85%}#settingsPanel{width:100%;right:-100%}}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>

<!-- WELCOME -->
<div id="welcomeScreen" class="screen active">
  <div class="wlogo">ğŸ“±</div>
  <div class="wtitle">VoxRoom</div>
  <div class="wsub">Crystal-clear calls even on slow connections. Create a room or join with a code.</div>
  <div class="wcard">
    <div class="fg">
      <label>Your Name</label>
      <input type="text" id="inputName" placeholder="Enter your name" maxlength="30" autocomplete="off">
    </div>
    <div class="btnrow">
      <button class="btn btn1" id="btnCreate"><span>ğŸ“</span> Create Room</button>
    </div>
    <div class="divider">or join existing</div>
    <div class="fg">
      <label>Room Code</label>
      <input type="text" id="inputCode" placeholder="e.g. ABC123" maxlength="6" style="text-transform:uppercase;letter-spacing:4px;text-align:center;font-size:20px;font-weight:700">
    </div>
    <div class="btnrow">
      <button class="btn btn2" id="btnJoin"><span>ğŸ”—</span> Join Room</button>
    </div>
    <div class="errmsg" id="welcomeError"></div>
  </div>
</div>

<!-- CHAT -->
<div id="chatScreen" class="screen">
  <div class="chdr">
    <div class="chdr-av" id="roomAvatar">V</div>
    <div class="chdr-info">
      <div class="chdr-name" id="roomName">VoxRoom</div>
      <div class="chdr-status" id="roomStatus">connecting...</div>
    </div>
    <div class="hacts">
      <button class="ibtn" id="btnCall" title="Start Call">ğŸ“</button>
      <button class="ibtn" id="btnSettings" title="Room Info">âš™ï¸</button>
    </div>
  </div>
  <div class="msgs" id="chatMessages">
    <div class="msg-sys">ğŸ”’ Messages are not stored. Calls are peer-to-peer.</div>
  </div>
  <div class="typing" id="typingIndicator"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div>
  <div class="inbar">
    <input type="text" id="chatInput" placeholder="Type a message" autocomplete="off">
    <button class="sendbtn" id="btnSend">â¤</button>
  </div>
</div>

<!-- CALL -->
<div id="callOverlay">
  <div class="cstatus">
    <div class="cav ring" id="callAvatar">V</div>
    <div class="cname" id="callRoomName">VoxRoom</div>
    <div class="ctimer" id="callTimer">Connecting...</div>
    <div class="cqual qg" id="callQuality">â— Excellent</div>
  </div>
  <div class="cpeers" id="callPeers"></div>
  <div class="cctrls">
    <button class="cbtn cbtn-mute" id="btnMute" title="Mute">ğŸ¤</button>
    <button class="cbtn cbtn-end" id="btnEndCall" title="End Call">ğŸ“µ</button>
    <button class="cbtn cbtn-spk" id="btnSpeaker" title="Speaker">ğŸ”Š</button>
  </div>
</div>

<!-- SETTINGS -->
<div class="backdrop" id="backdrop"></div>
<div id="settingsPanel">
  <div class="shdr">
    <button class="ibtn" id="btnCloseSettings">âœ•</button>
    <h3>Room Info</h3>
  </div>
  <div class="sbody">
    <div class="rcode">
      <div class="clbl">ROOM CODE</div>
      <div class="code" id="displayCode">------</div>
      <button class="cpybtn" id="btnCopyCode">ğŸ“‹ Copy Code</button>
    </div>
    <div class="ssec">
      <h4>Settings</h4>
      <div class="srow">
        <label>Max in Call</label>
        <select id="selectMaxCall">
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="8">8</option>
        </select>
      </div>
    </div>
    <div class="ssec">
      <h4>Participants</h4>
      <div class="plist" id="participantsList"></div>
    </div>
  </div>
</div>

<div id="audioContainer" style="display:none"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
(function(){
"use strict";

const S={socket:null,userId:null,userName:"",roomCode:null,roomData:null,isCreator:false,inCall:false,muted:false,speakerOn:false,localStream:null,peers:new Map(),callStart:null,callTimerInterval:null,netQuality:"good",typingTimeout:null};

const ICE={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"}],iceCandidatePoolSize:10};

function audioConstraints(){return{audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true,sampleRate:16000,channelCount:1,latency:0.01},video:false}}

const $=id=>document.getElementById(id);
const E={
  ws:$("welcomeScreen"),cs:$("chatScreen"),co:$("callOverlay"),sp:$("settingsPanel"),bd:$("backdrop"),
  iname:$("inputName"),icode:$("inputCode"),bcreate:$("btnCreate"),bjoin:$("btnJoin"),werr:$("welcomeError"),
  rav:$("roomAvatar"),rname:$("roomName"),rstat:$("roomStatus"),bcall:$("btnCall"),bset:$("btnSettings"),
  msgs:$("chatMessages"),typing:$("typingIndicator"),cinput:$("chatInput"),bsend:$("btnSend"),
  cav:$("callAvatar"),crname:$("callRoomName"),ctimer:$("callTimer"),cqual:$("callQuality"),cpeers:$("callPeers"),
  bmute:$("btnMute"),bend:$("btnEndCall"),bspk:$("btnSpeaker"),
  bclose:$("btnCloseSettings"),dcode:$("displayCode"),bcopy:$("btnCopyCode"),smax:$("selectMaxCall"),plist:$("participantsList"),
  ac:$("audioContainer")
};

function showScreen(n){document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));if(n==="welcome")E.ws.classList.add("active");else if(n==="chat")E.cs.classList.add("active")}
function showErr(m){E.werr.textContent=m;E.werr.classList.add("show");setTimeout(()=>E.werr.classList.remove("show"),4000)}
function esc(s){const d=document.createElement("div");d.textContent=s;return d.innerHTML}
function fmtTime(t){return new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}

function connectSocket(){
  if(S.socket)return;
  S.socket=io({transports:["websocket","polling"],reconnection:true,reconnectionAttempts:Infinity,reconnectionDelay:1000,reconnectionDelayMax:10000,timeout:20000});

  S.socket.on("connect",()=>{console.log("ğŸ”Œ Connected");updateConn("connected")});
  S.socket.on("disconnect",r=>{console.log("ğŸ”Œ Disconnected:",r);updateConn("disconnected")});
  S.socket.on("reconnect",()=>{
    console.log("ğŸ”Œ Reconnected");updateConn("connected");
    if(S.roomCode&&S.userName){S.socket.emit("room:join",{code:S.roomCode,userName:S.userName},r=>{if(r.ok)S.userId=r.userId})}
  });

  S.socket.on("room:update",d=>{S.roomData=d;updateRoomUI(d)});
  S.socket.on("chat:message",m=>appendMsg(m));
  S.socket.on("chat:typing",({userId:u,name:n})=>{if(u!==S.userId)showTyping(n)});

  S.socket.on("call:peer-joined",async({peerId:pid,peerName:pn,peerColor:pc,shouldOffer:so})=>{
    console.log(`ğŸ“ Peer: ${pn} (offer:${so})`);
    await setupPeer(pid,pn,pc,so);
  });
  S.socket.on("call:peer-left",({peerId:pid})=>{closePeer(pid);updateCallUI()});

  S.socket.on("rtc:offer",async({fromUserId:fid,offer:o})=>{
    const p=S.peers.get(fid);if(!p)return;
    try{await p.pc.setRemoteDescription(new RTCSessionDescription(o));const a=await p.pc.createAnswer();await p.pc.setLocalDescription(a);S.socket.emit("rtc:answer",{targetUserId:fid,answer:a})}catch(e){console.error("offer err:",e)}
  });
  S.socket.on("rtc:answer",async({fromUserId:fid,answer:a})=>{
    const p=S.peers.get(fid);if(!p)return;
    try{await p.pc.setRemoteDescription(new RTCSessionDescription(a))}catch(e){console.error("answer err:",e)}
  });
  S.socket.on("rtc:ice",async({fromUserId:fid,candidate:c})=>{
    const p=S.peers.get(fid);if(!p||!c)return;
    try{await p.pc.addIceCandidate(new RTCIceCandidate(c))}catch(e){console.error("ice err:",e)}
  });
  S.socket.on("net:peer-quality",({peerId:pid,quality:q})=>{
    const p=S.peers.get(pid);if(p){p.quality=q;adaptBitrate(pid,q)}
  });
}

function updateConn(st){
  if(!S.roomData)return;
  if(st==="connected"){const o=S.roomData.participants?S.roomData.participants.filter(p=>p.online).length:0;E.rstat.textContent=`${o} online`}
  else E.rstat.textContent="Reconnecting...";
}

// ROOM
function createRoom(){
  const n=E.iname.value.trim();if(!n){showErr("Enter your name");return}if(n.length<2){showErr("Name too short");return}
  connectSocket();S.userName=n;E.bcreate.disabled=true;E.bcreate.textContent="Creating...";
  S.socket.emit("room:create",{name:`${n}'s Room`,userName:n},r=>{
    E.bcreate.disabled=false;E.bcreate.innerHTML="<span>ğŸ“</span> Create Room";
    if(r.ok){S.userId=r.userId;S.roomCode=r.code;S.isCreator=true;showScreen("chat");E.rname.textContent=r.room.name;E.dcode.textContent=r.code;E.rav.textContent=r.room.name[0].toUpperCase()}
    else showErr(r.error||"Failed");
  });
}
function joinRoom(){
  const n=E.iname.value.trim(),c=E.icode.value.trim().toUpperCase();
  if(!n){showErr("Enter your name");return}if(n.length<2){showErr("Name too short");return}
  if(!c||c.length!==6){showErr("Enter 6-char room code");return}
  connectSocket();S.userName=n;E.bjoin.disabled=true;E.bjoin.textContent="Joining...";
  S.socket.emit("room:join",{code:c,userName:n},r=>{
    E.bjoin.disabled=false;E.bjoin.innerHTML="<span>ğŸ”—</span> Join Room";
    if(r.ok){S.userId=r.userId;S.roomCode=r.code;S.isCreator=false;showScreen("chat");E.rname.textContent=r.room.name;E.dcode.textContent=r.code;E.rav.textContent=r.room.name[0].toUpperCase()}
    else showErr(r.error||"Failed");
  });
}

function updateRoomUI(d){
  if(!d)return;
  const on=d.participants.filter(p=>p.online),ic=d.participants.filter(p=>p.inCall);
  E.rstat.textContent=on.length===1?"1 participant":`${on.length} participants`+(ic.length>0?` Â· ${ic.length} in call`:"");
  E.smax.value=d.maxCall;
  E.plist.innerHTML="";
  for(const p of d.participants){
    const div=document.createElement("div");div.className="part";
    div.innerHTML=`<div class="part-av" style="background:${p.color}">${p.name[0].toUpperCase()}</div><div class="part-info"><div class="part-name">${esc(p.name)}${p.id===d.creatorId?" ğŸ‘‘":""}</div><div class="part-stat">${p.inCall?"ğŸ”Š In call":p.online?"Online":"Offline"}</div></div><div class="odot ${p.online?"":"off"}"></div>`;
    E.plist.appendChild(div);
  }
  if(d.callActive&&!S.inCall){E.bcall.textContent="ğŸ“";E.bcall.title=`Join Call (${ic.length}/${d.maxCall})`}
  else if(S.inCall){E.bcall.textContent="ğŸ“µ";E.bcall.classList.add("active")}
  else{E.bcall.textContent="ğŸ“";E.bcall.classList.remove("active")}
}

// CHAT
function appendMsg(m){
  const c=E.msgs;
  if(m.type==="system"){const d=document.createElement("div");d.className="msg-sys";d.textContent=m.text;c.appendChild(d)}
  else{const me=m.userId===S.userId,d=document.createElement("div");d.className=`msg ${me?"msg-out":"msg-in"}`;let h="";if(!me)h+=`<div class="msg-sender" style="color:${m.userColor}">${esc(m.userName)}</div>`;h+=`<div class="msg-text">${esc(m.text)}</div><div class="msg-time">${fmtTime(m.time)}</div>`;d.innerHTML=h;c.appendChild(d)}
  c.scrollTop=c.scrollHeight;hideTyping();
}
function sendMsg(){const t=E.cinput.value.trim();if(!t||!S.socket)return;S.socket.emit("chat:send",{text:t});E.cinput.value=""}
let typTimer=null;
function showTyping(n){E.typing.classList.add("show");clearTimeout(typTimer);typTimer=setTimeout(hideTyping,3000)}
function hideTyping(){E.typing.classList.remove("show")}

// WebRTC
async function setupPeer(pid,pn,pc,shouldOffer){
  const rtc=new RTCPeerConnection(ICE);
  const pd={pc:rtc,name:pn,color:pc,stream:null,quality:"good"};
  S.peers.set(pid,pd);
  if(S.localStream)for(const t of S.localStream.getTracks())rtc.addTrack(t,S.localStream);

  rtc.onicecandidate=e=>{if(e.candidate)S.socket.emit("rtc:ice",{targetUserId:pid,candidate:e.candidate})};

  rtc.ontrack=e=>{
    console.log(`ğŸ”Š Track from ${pn}`);
    const stream=e.streams[0];pd.stream=stream;
    let a=document.getElementById(`audio-${pid}`);
    if(!a){a=document.createElement("audio");a.id=`audio-${pid}`;a.autoplay=true;a.playsInline=true;E.ac.appendChild(a)}
    a.srcObject=stream;
    a.play().catch(()=>{document.addEventListener("click",function r(){a.play().catch(()=>{});document.removeEventListener("click",r)},{once:true})});
    updateCallUI();
  };

  rtc.onconnectionstatechange=()=>{
    console.log(`ğŸ”— ${pn}: ${rtc.connectionState}`);
    if(rtc.connectionState==="connected"){startQualityMon(pid);updateCallUI()}
    else if(rtc.connectionState==="disconnected"){
      console.log(`âš ï¸ ${pn} disconnected, waiting...`);
      pd.dcTimer=setTimeout(()=>{
        const p=S.peers.get(pid);
        if(p&&p.pc.connectionState!=="connected"){console.log(`âŒ ${pn} gone`);closePeer(pid);updateCallUI()}
      },10000);
    }
    else if(rtc.connectionState==="failed"){
      console.log(`âŒ ${pn} failed, restarting ICE`);
      try{rtc.restartIce()}catch(e){console.error("ICE restart fail:",e);closePeer(pid);setTimeout(()=>{if(S.inCall)setupPeer(pid,pn,pc,true)},2000)}
    }
    else if(rtc.connectionState==="closed"){closePeer(pid);updateCallUI()}
  };

  rtc.oniceconnectionstatechange=()=>{
    console.log(`ğŸ§Š ICE ${pn}: ${rtc.iceConnectionState}`);
    if(rtc.iceConnectionState==="failed"){try{rtc.restartIce()}catch(e){}}
  };

  if(shouldOffer){
    try{
      const offer=await rtc.createOffer({offerToReceiveAudio:true,offerToReceiveVideo:false,voiceActivityDetection:true});
      offer.sdp=tweakSDP(offer.sdp);
      await rtc.setLocalDescription(offer);
      S.socket.emit("rtc:offer",{targetUserId:pid,offer:rtc.localDescription});
      console.log(`ğŸ“¤ Offer â†’ ${pn}`);
    }catch(e){console.error("Offer failed:",e)}
  }
  updateCallUI();
}

function tweakSDP(sdp){
  let m=sdp;
  if(S.netQuality==="poor"){
    m=m.replace(/a=fmtp:111 /g,"a=fmtp:111 maxaveragebitrate=12000;stereo=0;sprop-stereo=0;usedtx=1;cbr=0;");
    m=m.replace(/c=IN IP4 (.*)\r\n/g,"c=IN IP4 \$1\r\nb=AS:16\r\n");
  }else if(S.netQuality==="medium"){
    m=m.replace(/a=fmtp:111 /g,"a=fmtp:111 maxaveragebitrate=24000;stereo=0;usedtx=1;");
    m=m.replace(/c=IN IP4 (.*)\r\n/g,"c=IN IP4 \$1\r\nb=AS:32\r\n");
  }else{
    m=m.replace(/a=fmtp:111 /g,"a=fmtp:111 maxaveragebitrate=48000;stereo=0;usedtx=1;");
  }
  return m;
}

function closePeer(pid){
  const p=S.peers.get(pid);if(!p)return;
  if(p.dcTimer)clearTimeout(p.dcTimer);
  if(p.qInterval)clearInterval(p.qInterval);
  try{p.pc.close()}catch(e){}
  const a=document.getElementById(`audio-${pid}`);
  if(a){a.srcObject=null;a.remove()}
  S.peers.delete(pid);
  console.log(`ğŸ—‘ï¸ Peer closed: ${p.name}`);
}

// QUALITY MONITORING
function startQualityMon(pid){
  const p=S.peers.get(pid);if(!p)return;
  if(p.qInterval)clearInterval(p.qInterval);
  p.qInterval=setInterval(async()=>{
    if(!p.pc||p.pc.connectionState!=="connected"){clearInterval(p.qInterval);return}
    try{
      const stats=await p.pc.getStats();
      let rtt=0,lost=0,recv=0,jit=0;
      stats.forEach(r=>{
        if(r.type==="candidate-pair"&&r.state==="succeeded")rtt=r.currentRoundTripTime||0;
        if(r.type==="inbound-rtp"&&r.kind==="audio"){lost=r.packetsLost||0;recv=r.packetsReceived||0;jit=r.jitter||0}
      });
      const loss=recv>0?lost/(lost+recv):0;
      let q="good";
      if(rtt>0.4||loss>0.1||jit>0.05)q="poor";
      else if(rtt>0.2||loss>0.03||jit>0.02)q="medium";
      const prev=S.netQuality;S.netQuality=q;
      if(prev!==q){console.log(`ğŸ“Š Quality: ${q} (RTT:${(rtt*1000).toFixed(0)}ms loss:${(loss*100).toFixed(1)}%)`);S.socket.emit("net:quality",{quality:q});adaptAllBitrate(q)}
      updateQualityUI(q,rtt,loss);
    }catch(e){}
  },3000);
}

function adaptAllBitrate(q){for(const[pid]of S.peers)adaptBitrate(pid,q)}

function adaptBitrate(pid,q){
  const p=S.peers.get(pid);if(!p||!p.pc)return;
  const senders=p.pc.getSenders();
  for(const s of senders){
    if(s.track&&s.track.kind==="audio"){
      const params=s.getParameters();
      if(!params.encodings||params.encodings.length===0)params.encodings=[{}];
      switch(q){
        case"poor":params.encodings[0].maxBitrate=12000;break;
        case"medium":params.encodings[0].maxBitrate=24000;break;
        default:params.encodings[0].maxBitrate=48000;break;
      }
      s.setParameters(params).catch(e=>console.warn("Bitrate adapt fail:",e));
    }
  }
}

function updateQualityUI(q,rtt,loss){
  const ms=Math.round((rtt||0)*1000),lp=((loss||0)*100).toFixed(1);
  switch(q){
    case"good":E.cqual.className="cqual qg";E.cqual.textContent=`â— Excellent ${ms}ms`;break;
    case"medium":E.cqual.className="cqual qm";E.cqual.textContent=`â— Fair ${ms}ms Â· ${lp}% loss`;break;
    case"poor":E.cqual.className="cqual qp";E.cqual.textContent=`â— Poor ${ms}ms Â· ${lp}% loss`;break;
  }
}

// CALL MANAGEMENT
async function joinCall(){
  if(S.inCall){leaveCall();return}
  try{
    S.localStream=await navigator.mediaDevices.getUserMedia(audioConstraints());
    console.log("ğŸ¤ Mic acquired");
    S.inCall=true;S.callStart=Date.now();S.muted=false;S.speakerOn=false;
    E.co.classList.add("active");E.cav.classList.add("ring");
    E.crname.textContent=S.roomData?S.roomData.name:"VoxRoom";
    E.ctimer.textContent="Connecting...";
    E.bmute.classList.remove("muted");E.bmute.textContent="ğŸ¤";
    E.bspk.classList.remove("active");

    S.socket.emit("call:join",null,r=>{
      if(!r.ok){alert(r.error||"Cannot join call");leaveCall();return}
      console.log(`ğŸ“ Joined (${r.members} members)`);
      E.cav.classList.remove("ring");startCallTimer();
    });

    // Wake lock
    if("wakeLock"in navigator){try{S.wakeLock=await navigator.wakeLock.request("screen");console.log("ğŸ”† Wake lock")}catch(e){}}
  }catch(e){
    console.error("Mic error:",e);
    alert("Cannot access microphone. Please allow permission and try again.");
    S.inCall=false;
  }
}

function leaveCall(){
  console.log("ğŸ“µ Leaving call");S.inCall=false;
  if(S.localStream){S.localStream.getTracks().forEach(t=>t.stop());S.localStream=null}
  for(const[pid]of S.peers)closePeer(pid);
  S.peers.clear();
  if(S.callTimerInterval){clearInterval(S.callTimerInterval);S.callTimerInterval=null}
  E.co.classList.remove("active");
  S.socket.emit("call:leave");
  if(S.wakeLock){try{S.wakeLock.release()}catch(e){}S.wakeLock=null}
}

function toggleMute(){
  if(!S.localStream)return;
  S.muted=!S.muted;
  S.localStream.getAudioTracks().forEach(t=>{t.enabled=!S.muted});
  E.bmute.textContent=S.muted?"ğŸ”‡":"ğŸ¤";
  E.bmute.classList.toggle("muted",S.muted);
}

function toggleSpeaker(){
  S.speakerOn=!S.speakerOn;
  E.bspk.classList.toggle("active",S.speakerOn);
  E.ac.querySelectorAll("audio").forEach(a=>{
    if(a.setSinkId){a.setSinkId(S.speakerOn?"default":"").catch(()=>{})}
  });
}

function startCallTimer(){
  if(S.callTimerInterval)clearInterval(S.callTimerInterval);
  S.callTimerInterval=setInterval(()=>{
    if(!S.callStart)return;
    const el=Math.floor((Date.now()-S.callStart)/1000);
    const m=Math.floor(el/60).toString().padStart(2,"0");
    const s=(el%60).toString().padStart(2,"0");
    E.ctimer.textContent=`${m}:${s}`;
  },1000);
}

function updateCallUI(){
  E.cpeers.innerHTML="";
  for(const[pid,p]of S.peers){
    const d=document.createElement("div");d.className="cpeer";
    const st=p.pc.connectionState;
    let ico="ğŸ”„";if(st==="connected")ico="ğŸ”Š";else if(st==="disconnected")ico="âš ï¸";else if(st==="failed")ico="âŒ";
    d.innerHTML=`<div class="cpeer-av" style="background:${p.color||"#128C7E"}">${(p.name||"?")[0].toUpperCase()}</div><div class="cpeer-name">${ico} ${esc(p.name||"Peer")}</div>`;
    E.cpeers.appendChild(d);
  }
  if(S.peers.size===0&&S.inCall){E.ctimer.textContent="Waiting for others...";E.cav.classList.add("ring")}
  else E.cav.classList.remove("ring");
}

// SETTINGS
function openSettings(){E.sp.classList.add("open");E.bd.classList.add("show")}
function closeSettings(){E.sp.classList.remove("open");E.bd.classList.remove("show")}

function copyCode(){
  const c=E.dcode.textContent;if(!c||c==="------")return;
  if(navigator.clipboard){navigator.clipboard.writeText(c).then(()=>{E.bcopy.textContent="âœ… Copied!";setTimeout(()=>{E.bcopy.textContent="ğŸ“‹ Copy Code"},2000)}).catch(()=>fbCopy(c))}
  else fbCopy(c);
}

function fbCopy(t){
  const ta=document.createElement("textarea");ta.value=t;ta.style.position="fixed";ta.style.left="-9999px";
  document.body.appendChild(ta);ta.select();
  try{document.execCommand("copy");E.bcopy.textContent="âœ… Copied!"}catch(e){E.bcopy.textContent="âŒ Failed"}
  setTimeout(()=>{E.bcopy.textContent="ğŸ“‹ Copy Code"},2000);
  document.body.removeChild(ta);
}

function changeMax(){
  const v=parseInt(E.smax.value);
  if(v>=2&&v<=8&&S.socket)S.socket.emit("room:settings",{maxCall:v});
}

// EVENT LISTENERS
E.bcreate.addEventListener("click",createRoom);
E.bjoin.addEventListener("click",joinRoom);
E.iname.addEventListener("keydown",e=>{if(e.key==="Enter"){if(E.icode.value.trim())joinRoom();else createRoom()}});
E.icode.addEventListener("keydown",e=>{if(e.key==="Enter")joinRoom()});
E.icode.addEventListener("input",()=>{E.icode.value=E.icode.value.toUpperCase().replace(/[^A-Z0-9]/g,"")});
E.bsend.addEventListener("click",sendMsg);
E.cinput.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMsg()}});
E.cinput.addEventListener("input",()=>{
  if(S.socket&&S.roomCode){
    if(!S.typingTimeout)S.socket.emit("chat:typing");
    clearTimeout(S.typingTimeout);S.typingTimeout=setTimeout(()=>{S.typingTimeout=null},2000);
  }
});
E.bcall.addEventListener("click",joinCall);
E.bmute.addEventListener("click",toggleMute);
E.bend.addEventListener("click",leaveCall);
E.bspk.addEventListener("click",toggleSpeaker);
E.bset.addEventListener("click",openSettings);
E.bclose.addEventListener("click",closeSettings);
E.bd.addEventListener("click",closeSettings);
E.bcopy.addEventListener("click",copyCode);
E.smax.addEventListener("change",changeMax);

// VISIBILITY
document.addEventListener("visibilitychange",()=>{
  if(document.hidden){if(S.inCall)adaptAllBitrate("poor")}
  else{if(S.inCall)adaptAllBitrate(S.netQuality)}
});

// BEFOREUNLOAD
window.addEventListener("beforeunload",()=>{if(S.inCall)leaveCall();if(S.socket)S.socket.disconnect()});

// RECONNECT WATCHER â€” auto-rejoin call if disconnected
let wasInCall=false;
setInterval(()=>{
  if(S.socket&&S.socket.connected){
    if(wasInCall&&!S.inCall){console.log("ğŸ”„ Rejoining call...");joinCall();wasInCall=false}
  }
  wasInCall=S.inCall;
},5000);

E.iname.focus();
console.log("ğŸ“± VoxRoom loaded");
})();
</script>
</body>
</html>

  
