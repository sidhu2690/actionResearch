<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>VoxCall</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  background:#0a0a0a;color:#fff;
  height:100vh;display:flex;
  align-items:center;justify-content:center;
}

#joinScreen{text-align:center;padding:24px;width:100%;max-width:360px}
#joinScreen h1{font-size:48px;margin-bottom:4px}
#joinScreen p{color:#888;font-size:14px;margin-bottom:32px}
#codeInput{
  width:100%;padding:16px;font-size:28px;font-weight:700;
  text-align:center;letter-spacing:8px;text-transform:uppercase;
  background:#1a1a1a;border:2px solid #333;border-radius:12px;
  color:#fff;outline:none;
}
#codeInput:focus{border-color:#22c55e}
#codeInput::placeholder{color:#444;letter-spacing:4px;font-weight:400;font-size:16px}
#joinBtn{
  width:100%;padding:16px;margin-top:16px;font-size:18px;font-weight:600;
  background:#22c55e;color:#fff;border:none;border-radius:12px;cursor:pointer;
}
#joinBtn:hover{background:#16a34a}
#joinBtn:active{transform:scale(.98)}
#joinBtn:disabled{background:#333;color:#666;cursor:default}
#error{color:#ef4444;font-size:13px;margin-top:12px;min-height:20px}

#callScreen{
  display:none;text-align:center;padding:24px;width:100%;height:100vh;
  flex-direction:column;align-items:center;justify-content:space-between;
  padding:60px 24px 80px;
}
#callScreen.active{display:flex}
#joinScreen.hidden{display:none}

.room-label{font-size:14px;color:#888;margin-bottom:4px}
.room-code{font-size:20px;font-weight:700;letter-spacing:4px;color:#22c55e;font-family:'Courier New',monospace}

.call-circle{
  width:140px;height:140px;border-radius:50%;background:#1a1a1a;
  border:3px solid #333;display:flex;align-items:center;justify-content:center;
  font-size:56px;margin:0 auto;transition:all .3s;
}
.call-circle.connected{border-color:#22c55e;box-shadow:0 0 40px #22c55e22}
.call-circle.waiting{animation:wp 2s infinite}
@keyframes wp{0%,100%{border-color:#333}50%{border-color:#22c55e55;box-shadow:0 0 30px #22c55e11}}

#callStatus{font-size:18px;font-weight:500;margin-top:16px}
#callTimer{font-size:14px;color:#888;margin-top:4px;font-family:'Courier New',monospace}

/* Volume visualizer */
#volBar{
  width:120px;height:6px;background:#222;border-radius:3px;
  margin:12px auto 0;overflow:hidden;
}
#volFill{
  width:0%;height:100%;background:#22c55e;border-radius:3px;
  transition:width .1s;
}

.controls{display:flex;gap:24px;align-items:center}
.ctrl-btn{
  width:64px;height:64px;border-radius:50%;border:none;cursor:pointer;
  font-size:28px;color:#fff;display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.ctrl-btn:active{transform:scale(.9)}
#muteBtn{background:#333}
#muteBtn.muted{background:#ef4444}
#hangBtn{background:#ef4444;width:72px;height:72px;font-size:32px}
#hangBtn:hover{background:#dc2626}
</style>
</head>
<body>

<div id="joinScreen">
  <h1>ðŸ“ž</h1>
  <p>Enter a room code. Same code = instant call.</p>
  <input type="text" id="codeInput" placeholder="ROOM CODE" maxlength="8" autocomplete="off">
  <button id="joinBtn">Join Room</button>
  <div id="error"></div>
</div>

<div id="callScreen">
  <div>
    <div class="room-label">ROOM</div>
    <div class="room-code" id="showCode">------</div>
  </div>
  <div>
    <div class="call-circle waiting" id="callCircle">ðŸ“ž</div>
    <div id="callStatus">Waiting for other person...</div>
    <div id="callTimer"></div>
    <div id="volBar"><div id="volFill"></div></div>
  </div>
  <div class="controls">
    <button class="ctrl-btn" id="muteBtn">ðŸŽ¤</button>
    <button class="ctrl-btn" id="hangBtn">ðŸ“µ</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
(function(){

let socket = null;
let audioCtx = null;
let micStream = null;
let micSource = null;
let processor = null;
let playbackQueue = [];
let playing = false;
let muted = false;
let callStart = null;
let timerInterval = null;
let currentRoom = null;
let connected = false;

const $ = id => document.getElementById(id);

// â”€â”€ JOIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$("joinBtn").onclick = join;
$("codeInput").onkeydown = e => { if(e.key==="Enter") join(); };
$("codeInput").oninput = () => {
  $("codeInput").value = $("codeInput").value.toUpperCase().replace(/[^A-Z0-9]/g,"");
};

function join(){
  const code = $("codeInput").value.trim();
  if(!code || code.length < 3){
    $("error").textContent = "Enter at least 3 characters";
    return;
  }

  $("joinBtn").disabled = true;
  $("joinBtn").textContent = "Getting mic...";
  $("error").textContent = "";

  // Get mic first
  navigator.mediaDevices.getUserMedia({
    audio: {
      echoCancellation: true,
      noiseSuppression: true,
      autoGainControl: true,
    },
    video: false,
  }).then(stream => {
    micStream = stream;
    $("joinBtn").textContent = "Joining...";
    connectAndJoin(code);
  }).catch(e => {
    $("joinBtn").disabled = false;
    $("joinBtn").textContent = "Join Room";
    $("error").textContent = "Mic access denied. Allow microphone and try again.";
  });
}

function connectAndJoin(code){
  socket = io({
    transports: ["websocket", "polling"],
    reconnection: true,
    reconnectionDelay: 1000,
  });

  socket.on("connect", () => {
    socket.emit("join", code, res => {
      if(!res.ok){
        $("joinBtn").disabled = false;
        $("joinBtn").textContent = "Join Room";
        $("error").textContent = res.error;
        cleanup();
        return;
      }
      currentRoom = code;
      showCallScreen(code);

      if(res.count === 2){
        startAudio();
      }
    });
  });

  socket.on("room-count", n => {
    if(n >= 2 && !connected){
      startAudio();
    }
    if(n < 2){
      connected = false;
      $("callStatus").textContent = "Waiting for other person...";
      $("callCircle").className = "call-circle waiting";
      $("callCircle").textContent = "ðŸ“ž";
      $("callTimer").textContent = "";
      stopTimer();
    }
  });

  // Receive audio from other person
  socket.on("audio", (data) => {
    playAudio(data);
  });

  socket.on("peer-left", () => {
    connected = false;
    $("callStatus").textContent = "Other person left. Waiting...";
    $("callCircle").className = "call-circle waiting";
    $("callCircle").textContent = "ðŸ“ž";
    $("callTimer").textContent = "";
    $("volFill").style.width = "0%";
    stopTimer();
  });

  socket.on("disconnect", () => {
    $("callStatus").textContent = "Reconnecting...";
  });

  socket.on("reconnect", () => {
    if(currentRoom){
      socket.emit("join", currentRoom, res => {
        if(res.ok && res.count >= 2) startAudio();
      });
    }
  });
}

function showCallScreen(code){
  $("joinScreen").classList.add("hidden");
  $("callScreen").classList.add("active");
  $("showCode").textContent = code;
}

// â”€â”€ AUDIO CAPTURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startAudio(){
  if(connected) return;
  connected = true;

  $("callStatus").textContent = "Connected";
  $("callCircle").className = "call-circle connected";
  $("callCircle").textContent = "ðŸ”Š";
  startTimer();

  // Create audio context
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)({
      sampleRate: 16000,  // 16kHz â€” good for voice, low bandwidth
    });
  }

  if(audioCtx.state === "suspended") audioCtx.resume();

  // Connect mic to processor
  micSource = audioCtx.createMediaStreamSource(micStream);

  // Use ScriptProcessorNode (works everywhere)
  // Buffer size 4096 at 16kHz = 256ms chunks = ~32KB/s raw, we compress
  processor = audioCtx.createScriptProcessor(4096, 1, 1);

  processor.onaudioprocess = (e) => {
    if(muted || !connected || !socket) return;

    const input = e.inputBuffer.getChannelData(0);

    // Convert Float32 â†’ Int16 (halves the data)
    const buf = new Int16Array(input.length);
    for(let i = 0; i < input.length; i++){
      let s = Math.max(-1, Math.min(1, input[i]));
      buf[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
    }

    // Simple compression: skip if silence
    let maxVal = 0;
    for(let i = 0; i < buf.length; i++){
      const v = Math.abs(buf[i]);
      if(v > maxVal) maxVal = v;
    }

    // Update volume bar
    const vol = Math.min(100, (maxVal / 3000) * 100);
    $("volFill").style.width = vol + "%";

    // Only send if there's actual sound (voice activity detection)
    if(maxVal > 200){
      socket.volatile.emit("audio", buf.buffer);
    }
  };

  micSource.connect(processor);
  processor.connect(audioCtx.destination);  // needed for processor to run
}

// â”€â”€ AUDIO PLAYBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playAudio(arrayBuf){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)({
      sampleRate: 16000,
    });
  }
  if(audioCtx.state === "suspended") audioCtx.resume();

  try{
    // Convert Int16 back to Float32
    const int16 = new Int16Array(arrayBuf);
    const float32 = new Float32Array(int16.length);
    for(let i = 0; i < int16.length; i++){
      float32[i] = int16[i] / (int16[i] < 0 ? 0x8000 : 0x7FFF);
    }

    // Create audio buffer and play
    const audioBuf = audioCtx.createBuffer(1, float32.length, 16000);
    audioBuf.getChannelData(0).set(float32);

    const source = audioCtx.createBufferSource();
    source.buffer = audioBuf;

    // Small gain to avoid clipping
    const gain = audioCtx.createGain();
    gain.gain.value = 1.5;

    source.connect(gain);
    gain.connect(audioCtx.destination);
    source.start();

    // Update volume bar for incoming audio
    let maxVal = 0;
    for(let i = 0; i < float32.length; i++){
      const v = Math.abs(float32[i]);
      if(v > maxVal) maxVal = v;
    }
    const vol = Math.min(100, maxVal * 150);
    $("volFill").style.width = vol + "%";

  }catch(e){
    // Ignore playback errors silently
  }
}

// â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTimer(){
  callStart = Date.now();
  stopTimer();
  timerInterval = setInterval(() => {
    const s = Math.floor((Date.now() - callStart) / 1000);
    const m = Math.floor(s/60).toString().padStart(2,"0");
    const sec = (s%60).toString().padStart(2,"0");
    $("callTimer").textContent = `${m}:${sec}`;
  }, 1000);
}
function stopTimer(){
  if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
}

// â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$("muteBtn").onclick = () => {
  muted = !muted;
  $("muteBtn").textContent = muted ? "ðŸ”‡" : "ðŸŽ¤";
  $("muteBtn").classList.toggle("muted", muted);
  if(muted) $("volFill").style.width = "0%";
};

$("hangBtn").onclick = () => {
  cleanup();
  // Back to join screen
  $("callScreen").classList.remove("active");
  $("joinScreen").classList.remove("hidden");
  $("joinBtn").disabled = false;
  $("joinBtn").textContent = "Join Room";
  $("callTimer").textContent = "";
  $("codeInput").value = "";
  $("volFill").style.width = "0%";
};

function cleanup(){
  connected = false;
  stopTimer();
  if(processor){ try{processor.disconnect()}catch(e){} processor=null; }
  if(micSource){ try{micSource.disconnect()}catch(e){} micSource=null; }
  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
  if(audioCtx){ try{audioCtx.close()}catch(e){} audioCtx=null; }
  if(socket){ socket.disconnect(); socket=null; }
  currentRoom = null;
}

// â”€â”€ KEEP SCREEN ON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let wakeLock = null;
async function keepAwake(){
  if(!("wakeLock" in navigator)) return;
  try{ wakeLock = await navigator.wakeLock.request("screen"); }catch(e){}
}
keepAwake();
document.addEventListener("visibilitychange", () => { if(!document.hidden) keepAwake(); });

// â”€â”€ HANDLE TAB CLOSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener("beforeunload", cleanup);

$("codeInput").focus();
console.log("ðŸ“ž VoxCall ready (server-relay mode)");

})();
</script>
</body>
</html>
